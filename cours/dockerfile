##############################################################################
# Bienvenue dans votre environnement de dÃ©veloppement PHP / Laravel / BDD
#
# Ce conteneur Docker sera votre environnement de travail tout au long
# du module. Il contient :
#   - PHP 8.6 (en ligne de commande)
#   - Composer (pour gÃ©rer les dÃ©pendances PHP)
#   - Tout ce quâ€™il faut pour exÃ©cuter un projet Laravel
#   - Les extensions et clients nÃ©cessaires pour PostgreSQL et MongoDB
#
# Lâ€™objectif est que vous puissiez coder, tester et exÃ©cuter vos
# applications web sans rien installer sur votre machine.
# Vous aurez juste Ã  partager votre dossier "projets" avec ce conteneur.
##############################################################################

# Je pars de lâ€™image officielle PHP 8.3 (version CLI uniquement)
FROM php:8.3-cli

# Je dÃ©sactive les prompts interactifs dâ€™APT pour automatiser les installations
ENV DEBIAN_FRONTEND=noninteractive

##############################################################################
# Installation des dÃ©pendances systÃ¨me
# Je vais maintenant installer tous les outils nÃ©cessaires au dÃ©veloppement
##############################################################################
RUN apt-get update && apt-get install -y \
    # Editeur en ligne de commande
    nano \
    # Affichage de l'arborescence
    tree \
    # Outil de versionnage de code (GitHub, GitLab, etc.)    
    git \
    # Permet de dÃ©compresser les archives (utile pour Composer)
    unzip \
    # Utilitaire pour tÃ©lÃ©charger des fichiers depuis le web
    curl \
    # Permet de crÃ©er des fichiers ZIP (nÃ©cessaire Ã  Laravel)
    zip \
    # Librairie utilisÃ©e par PHP pour gÃ©rer les fichiers ZIP
    libzip-dev \
    # Librairie nÃ©cessaire pour la connexion Ã  PostgreSQL
    libpq-dev \
    # Librairie pour le chiffrement et les connexions sÃ©curisÃ©es (SSL/TLS)
    libssl-dev \
    # Outil de configuration pour compiler certaines extensions
    pkg-config \
    # Librairie cURL pour les requÃªtes HTTP (utilisÃ©e par Composer et Laravel)
    libcurl4-openssl-dev \
    # Librairie XML (utilisÃ©e par plusieurs extensions PHP)
    libxml2-dev \
    # Permet la vÃ©rification de signatures (utile pour certaines installations sÃ©curisÃ©es)
    gnupg \
    # Autre outil pour tÃ©lÃ©charger des fichiers
    wget \
    # Client PostgreSQL pour interagir avec une base distante
    postgresql-client \
    # Nettoyage du cache pour allÃ©ger lâ€™image
    && rm -rf /var/lib/apt/lists/*

##############################################################################
# Installation de mongosh (MongoDB Shell) via le binaire officiel
##############################################################################
# Sur les mac avec apple silicon il faut remplacer "amd64" par "arm64"
# Pour les autres : https://www.mongodb.com/try/download/shell
RUN wget -q https://downloads.mongodb.com/compass/mongodb-mongosh_1.10.6_arm64.deb \
    && dpkg -i mongodb-mongosh_1.10.6_arm64.deb \
    && apt-get install -f -y \
    && rm mongodb-mongosh_1.10.6_arm64.deb

##############################################################################
# Installation des extensions PHP nÃ©cessaires Ã  Laravel
##############################################################################
    # Extensions PHP pour PostgreSQL et gestion des archives ZIP
RUN docker-php-ext-install pdo pdo_pgsql pgsql zip \
    # Installation de lâ€™extension MongoDB depuis PECL
    && pecl install mongodb \
    # Activation de lâ€™extension MongoDB
    && docker-php-ext-enable mongodb

##############################################################################
# Installation de Composer (le gestionnaire de dÃ©pendances PHP)
##############################################################################
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

##############################################################################
# CrÃ©ation du dossier utilisateur et configuration du dossier de travail
##############################################################################
RUN useradd -m dev

##############################################################################
# Dossier de travail
##############################################################################
WORKDIR /labs

##############################################################################
# Petit message dâ€™accueil quand vous entrez dans le conteneur
##############################################################################
RUN echo 'Bienvenue dans le conteneur PHP 8.6 (Laravel / MongoDB / PostgreSQL)' > /etc/motd

##############################################################################
# ğŸ§© Commande par dÃ©faut : ouverture dâ€™un terminal Bash
##############################################################################
CMD ["/bin/bash"]
